shadow$provide.module$node_modules$ws$lib$WebSocket=function(global,require,module,exports){function initAsServerClient(socket,head,options){this.protocolVersion=options.protocolVersion;this._maxPayload=options.maxPayload;this.extensions=options.extensions;this.protocol=options.protocol;this._isServer=!0;this.setSocket(socket,head)}function initAsClient(address,protocols,options){var $jscomp$this=this;options=Object.assign({protocolVersion:protocolVersions[1],protocol:protocols.join(","),perMessageDeflate:!0,
handshakeTimeout:null,localAddress:null,headers:null,family:null,origin:null,agent:null,host:null,checkServerIdentity:null,rejectUnauthorized:null,passphrase:null,ciphers:null,ecdhCurve:null,cert:null,key:null,pfx:null,ca:null},options);if(-1===protocolVersions.indexOf(options.protocolVersion))throw Error("unsupported protocol version: "+options.protocolVersion+" (supported versions: "+(protocolVersions.join(", ")+")"));this.protocolVersion=options.protocolVersion;this._isServer=!1;this.url=address;
var serverUrl=url.parse(address),isUnixSocket="ws+unix:"===serverUrl.protocol;if(!(serverUrl.host||isUnixSocket&&serverUrl.path))throw Error("invalid url");protocols="wss:"===serverUrl.protocol||"https:"===serverUrl.protocol;var key=crypto.randomBytes(16).toString("base64");address=protocols?https:http;protocols={port:serverUrl.port||(protocols?443:80),host:serverUrl.hostname,path:"/",headers:{"Sec-WebSocket-Version":options.protocolVersion,"Sec-WebSocket-Key":key,Connection:"Upgrade",Upgrade:"websocket"}};
options.headers&&Object.assign(protocols.headers,options.headers);if(options.perMessageDeflate){var perMessageDeflate=new PerMessageDeflate(!0!==options.perMessageDeflate?options.perMessageDeflate:{},!1);var $jscomp$compprop0={};protocols.headers["Sec-WebSocket-Extensions"]=Extensions.format(($jscomp$compprop0[PerMessageDeflate.extensionName]=perMessageDeflate.offer(),$jscomp$compprop0))}options.protocol&&(protocols.headers["Sec-WebSocket-Protocol"]=options.protocol);options.origin&&(13>options.protocolVersion?
protocols.headers["Sec-WebSocket-Origin"]=options.origin:protocols.headers.Origin=options.origin);options.host&&(protocols.headers.Host=options.host);serverUrl.auth&&(protocols.auth=serverUrl.auth);options.localAddress&&(protocols.localAddress=options.localAddress);options.family&&(protocols.family=options.family);isUnixSocket?(serverUrl=serverUrl.path.split(":"),protocols.socketPath=serverUrl[0],protocols.path=serverUrl[1]):serverUrl.path&&("/"!==serverUrl.path.charAt(0)?protocols.path="/"+serverUrl.path:
protocols.path=serverUrl.path);serverUrl=options.agent;if(null!=options.rejectUnauthorized||options.checkServerIdentity||options.passphrase||options.ciphers||options.ecdhCurve||options.cert||options.key||options.pfx||options.ca)options.passphrase&&(protocols.passphrase=options.passphrase),options.ciphers&&(protocols.ciphers=options.ciphers),options.ecdhCurve&&(protocols.ecdhCurve=options.ecdhCurve),options.cert&&(protocols.cert=options.cert),options.key&&(protocols.key=options.key),options.pfx&&(protocols.pfx=
options.pfx),options.ca&&(protocols.ca=options.ca),options.checkServerIdentity&&(protocols.checkServerIdentity=options.checkServerIdentity),null!=options.rejectUnauthorized&&(protocols.rejectUnauthorized=options.rejectUnauthorized),serverUrl||(serverUrl=new address.Agent(protocols));serverUrl&&(protocols.agent=serverUrl);this._req=address.get(protocols);options.handshakeTimeout&&this._req.setTimeout(options.handshakeTimeout,function(){$jscomp$this._req.abort();$jscomp$this.finalize(Error("opening handshake has timed out"))});
this._req.on("error",function(error){$jscomp$this._req.aborted||($jscomp$this._req=null,$jscomp$this.finalize(error))});this._req.on("response",function(res){$jscomp$this.emit("unexpected-response",$jscomp$this._req,res)||($jscomp$this._req.abort(),$jscomp$this.finalize(Error("unexpected server response ("+res.statusCode+")")))});this._req.on("upgrade",function(res,socket,head){$jscomp$this.emit("headers",res.headers,res);if($jscomp$this.readyState===WebSocket.CONNECTING){$jscomp$this._req=null;var digest=
crypto.createHash("sha1").update(key+constants.GUID,"binary").digest("base64");if(res.headers["sec-websocket-accept"]!==digest)return socket.destroy(),$jscomp$this.finalize(Error("invalid server key"));digest=res.headers["sec-websocket-protocol"];var protList=(options.protocol||"").split(/, */),protError;!options.protocol&&digest?protError="server sent a subprotocol even though none requested":options.protocol&&!digest?protError="server sent no subprotocol even though requested":digest&&-1===protList.indexOf(digest)&&
(protError="server responded with an invalid protocol");if(protError)return socket.destroy(),$jscomp$this.finalize(Error(protError));digest&&($jscomp$this.protocol=digest);if(perMessageDeflate)try{var serverExtensions=Extensions.parse(res.headers["sec-websocket-extensions"]);serverExtensions[PerMessageDeflate.extensionName]&&(perMessageDeflate.accept(serverExtensions[PerMessageDeflate.extensionName]),$jscomp$this.extensions[PerMessageDeflate.extensionName]=perMessageDeflate)}catch(err){socket.destroy();
$jscomp$this.finalize(Error("invalid Sec-WebSocket-Extensions header"));return}$jscomp$this.setSocket(socket,head)}})}var EventEmitter=require("module$node_modules$events$events"),crypto=require("module$node_modules$crypto_browserify$index"),Ultron=require("module$node_modules$ultron$index"),https=require("module$node_modules$https_browserify$index"),http=require("module$node_modules$stream_http$index"),url=require("module$node_modules$url$url"),PerMessageDeflate=require("module$node_modules$ws$lib$PerMessageDeflate");
global=require("module$node_modules$ws$lib$EventTarget");var Extensions=require("module$node_modules$ws$lib$Extensions"),constants=require("module$node_modules$ws$lib$Constants"),Receiver=require("module$node_modules$ws$lib$Receiver"),Sender=require("module$node_modules$ws$lib$Sender"),protocolVersions=[8,13],WebSocket=function(address,protocols,options){var $jscomp$super$this=EventEmitter.call(this)||this;protocols?"string"===typeof protocols?protocols=[protocols]:Array.isArray(protocols)||(options=
protocols,protocols=[]):protocols=[];$jscomp$super$this.readyState=WebSocket.CONNECTING;$jscomp$super$this.bytesReceived=0;$jscomp$super$this.extensions={};$jscomp$super$this.protocol="";$jscomp$super$this._binaryType=constants.BINARY_TYPES[0];$jscomp$super$this._finalize=$jscomp$super$this.finalize.bind($jscomp$super$this);$jscomp$super$this._closeFrameReceived=!1;$jscomp$super$this._closeFrameSent=!1;$jscomp$super$this._closeMessage="";$jscomp$super$this._closeTimer=null;$jscomp$super$this._finalized=
!1;$jscomp$super$this._closeCode=1006;$jscomp$super$this._receiver=null;$jscomp$super$this._sender=null;$jscomp$super$this._socket=null;$jscomp$super$this._ultron=null;Array.isArray(address)?initAsServerClient.call($jscomp$super$this,address[0],address[1],options):initAsClient.call($jscomp$super$this,address,protocols,options);return $jscomp$super$this};$jscomp.inherits(WebSocket,EventEmitter);WebSocket.prototype.setSocket=function(socket,head){var $jscomp$this=this;socket.setTimeout(0);socket.setNoDelay();
this._receiver=new Receiver(this.extensions,this._maxPayload,this.binaryType);this._sender=new Sender(socket,this.extensions);this._ultron=new Ultron(socket);this._socket=socket;this._ultron.on("close",this._finalize);this._ultron.on("error",this._finalize);this._ultron.on("end",this._finalize);0<head.length&&socket.unshift(head);this._ultron.on("data",function(data){$jscomp$this.bytesReceived+=data.length;$jscomp$this._receiver.add(data)});this._receiver.onmessage=function(data){return $jscomp$this.emit("message",
data)};this._receiver.onping=function(data){$jscomp$this.pong(data,!$jscomp$this._isServer,!0);$jscomp$this.emit("ping",data)};this._receiver.onpong=function(data){return $jscomp$this.emit("pong",data)};this._receiver.onclose=function(code,reason){$jscomp$this._closeFrameReceived=!0;$jscomp$this._closeMessage=reason;$jscomp$this._closeCode=code;$jscomp$this._finalized||$jscomp$this.close(code,reason)};this._receiver.onerror=function(error,code){$jscomp$this._closeMessage="";$jscomp$this._closeCode=
code;$jscomp$this.readyState=WebSocket.CLOSING;$jscomp$this.emit("error",error);$jscomp$this.finalize(!0)};this.readyState=WebSocket.OPEN;this.emit("open")};WebSocket.prototype.finalize=function(error){var $jscomp$this=this;if(!this._finalized){this.readyState=WebSocket.CLOSING;this._finalized=!0;"object"===typeof error&&this.emit("error",error);if(!this._socket)return this.emitClose();clearTimeout(this._closeTimer);this._closeTimer=null;this._ultron.destroy();this._ultron=null;this._socket.on("error",
constants.NOOP);error?this._socket.destroy():this._socket.end();this._sender=this._socket=null;this._receiver.cleanup(function(){return $jscomp$this.emitClose()});this._receiver=null}};WebSocket.prototype.emitClose=function(){this.readyState=WebSocket.CLOSED;this.emit("close",this._closeCode,this._closeMessage);this.extensions[PerMessageDeflate.extensionName]&&this.extensions[PerMessageDeflate.extensionName].cleanup();this.extensions=null;this.removeAllListeners()};WebSocket.prototype.pause=function(){if(this.readyState!==
WebSocket.OPEN)throw Error("not opened");this._socket.pause()};WebSocket.prototype.resume=function(){if(this.readyState!==WebSocket.OPEN)throw Error("not opened");this._socket.resume()};WebSocket.prototype.close=function(code,data){var $jscomp$this=this;this.readyState!==WebSocket.CLOSED&&(this.readyState===WebSocket.CONNECTING?(this._req.abort(),this.finalize(Error("closed before the connection is established"))):this.readyState===WebSocket.CLOSING?this._closeFrameSent&&this._closeFrameReceived&&
this._socket.end():(this.readyState=WebSocket.CLOSING,this._sender.close(code,data,!this._isServer,function(err){err||($jscomp$this._closeFrameSent=!0,$jscomp$this._finalized||($jscomp$this._closeFrameReceived&&$jscomp$this._socket.end(),$jscomp$this._closeTimer=setTimeout($jscomp$this._finalize,3E4,!0)))})))};WebSocket.prototype.ping=function(data,mask,failSilently){if(this.readyState!==WebSocket.OPEN){if(failSilently)return;throw Error("not opened");}"number"===typeof data&&(data=data.toString());
void 0===mask&&(mask=!this._isServer);this._sender.ping(data||constants.EMPTY_BUFFER,mask)};WebSocket.prototype.pong=function(data,mask,failSilently){if(this.readyState!==WebSocket.OPEN){if(failSilently)return;throw Error("not opened");}"number"===typeof data&&(data=data.toString());void 0===mask&&(mask=!this._isServer);this._sender.pong(data||constants.EMPTY_BUFFER,mask)};WebSocket.prototype.send=function(data,options,cb){"function"===typeof options&&(cb=options,options={});if(this.readyState!==
WebSocket.OPEN)if(cb)cb(Error("not opened"));else throw Error("not opened");else"number"===typeof data&&(data=data.toString()),options=Object.assign({binary:"string"!==typeof data,mask:!this._isServer,compress:!0,fin:!0},options),this.extensions[PerMessageDeflate.extensionName]||(options.compress=!1),this._sender.send(data||constants.EMPTY_BUFFER,options,cb)};WebSocket.prototype.terminate=function(){this.readyState!==WebSocket.CLOSED&&(this.readyState===WebSocket.CONNECTING?(this._req.abort(),this.finalize(Error("closed before the connection is established"))):
this.finalize(!0))};$jscomp.global.Object.defineProperties(WebSocket.prototype,{CONNECTING:{configurable:!0,enumerable:!0,get:function(){return WebSocket.CONNECTING}},CLOSING:{configurable:!0,enumerable:!0,get:function(){return WebSocket.CLOSING}},CLOSED:{configurable:!0,enumerable:!0,get:function(){return WebSocket.CLOSED}},OPEN:{configurable:!0,enumerable:!0,get:function(){return WebSocket.OPEN}},bufferedAmount:{configurable:!0,enumerable:!0,get:function(){var amount=0;this._socket&&(amount=this._socket.bufferSize+
this._sender._bufferedBytes);return amount}},binaryType:{configurable:!0,enumerable:!0,get:function(){return this._binaryType},set:function(type){0>constants.BINARY_TYPES.indexOf(type)||(this._binaryType=type,this._receiver&&(this._receiver._binaryType=type))}}});WebSocket.CONNECTING=0;WebSocket.OPEN=1;WebSocket.CLOSING=2;WebSocket.CLOSED=3;["open","error","close","message"].forEach(function(method){Object.defineProperty(WebSocket.prototype,"on"+method,{get:function(){for(var listeners=this.listeners(method),
i=0;i<listeners.length;i++)if(listeners[i]._listener)return listeners[i]._listener},set:function(listener){for(var listeners=this.listeners(method),i=0;i<listeners.length;i++)listeners[i]._listener&&this.removeListener(method,listeners[i]);this.addEventListener(method,listener)}})});WebSocket.prototype.addEventListener=global.addEventListener;WebSocket.prototype.removeEventListener=global.removeEventListener;module.exports=WebSocket}
//# sourceMappingURL=module$node_modules$ws$lib$WebSocket.js.map
