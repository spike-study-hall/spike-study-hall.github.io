shadow$provide.module$node_modules$peer$dist$src$services$messagesExpire$index=function(global,require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});var enums_1=require("module$node_modules$peer$dist$src$enums");global=function($jscomp$destructuring$var3){var realm=$jscomp$destructuring$var3.realm,config=$jscomp$destructuring$var3.config;$jscomp$destructuring$var3=$jscomp$destructuring$var3.messageHandler;this.timeoutId=null;this.realm=realm;this.config=config;this.messageHandler=
$jscomp$destructuring$var3};global.prototype.startMessagesExpiration=function(){var $jscomp$this=this;this.timeoutId&&clearTimeout(this.timeoutId);this.timeoutId=setTimeout(function(){$jscomp$this.pruneOutstanding();$jscomp$this.timeoutId=null;$jscomp$this.startMessagesExpiration()},this.config.cleanup_out_msgs)};global.prototype.stopMessagesExpiration=function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)};global.prototype.pruneOutstanding=function(){var destinationClientsIds=
this.realm.getClientsIdsWithQueue(),now=(new Date).getTime(),maxDiff=this.config.expire_timeout,seen={};destinationClientsIds=$jscomp.makeIterator(destinationClientsIds);for(var $jscomp$key$destinationClientId=destinationClientsIds.next();!$jscomp$key$destinationClientId.done;$jscomp$key$destinationClientId=destinationClientsIds.next()){$jscomp$key$destinationClientId=$jscomp$key$destinationClientId.value;var messageQueue=this.realm.getMessageQueueById($jscomp$key$destinationClientId);if(!(now-messageQueue.getLastReadAt()<
maxDiff)){messageQueue=messageQueue.getMessages();messageQueue=$jscomp.makeIterator(messageQueue);for(var $jscomp$key$message=messageQueue.next();!$jscomp$key$message.done;$jscomp$key$message=messageQueue.next()){$jscomp$key$message=$jscomp$key$message.value;var seenKey=$jscomp$key$message.src+"_"+$jscomp$key$message.dst;seen[seenKey]||(this.messageHandler.handle(void 0,{type:enums_1.MessageType.EXPIRE,src:$jscomp$key$message.dst,dst:$jscomp$key$message.src}),seen[seenKey]=!0)}this.realm.clearMessageQueue($jscomp$key$destinationClientId)}}};
exports.MessagesExpire=global}
//# sourceMappingURL=module$node_modules$peer$dist$src$services$messagesExpire$index.js.map
