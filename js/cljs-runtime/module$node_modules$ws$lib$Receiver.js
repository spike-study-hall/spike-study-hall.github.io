shadow$provide.module$node_modules$ws$lib$Receiver=function(global,require,module,exports){function toBuffer(fragments,messageLength){return 1===fragments.length?fragments[0]:1<fragments.length?bufferUtil.concat(fragments,messageLength):constants.EMPTY_BUFFER}global=require("module$node_modules$safe_buffer$index");var PerMessageDeflate=require("module$node_modules$ws$lib$PerMessageDeflate"),isValidUTF8=require("module$node_modules$ws$lib$Validation"),bufferUtil=require("module$node_modules$ws$lib$BufferUtil"),
ErrorCodes=require("module$node_modules$ws$lib$ErrorCodes"),constants=require("module$node_modules$ws$lib$Constants"),Buffer=global.Buffer;require=function(extensions,maxPayload,binaryType){this._binaryType=binaryType||constants.BINARY_TYPES[0];this._extensions=extensions||{};this._maxPayload=maxPayload|0;this._bufferedBytes=0;this._buffers=[];this._compressed=!1;this._fragmented=this._payloadLength=0;this._fin=this._masked=!1;this._mask=null;this._messageLength=this._totalPayloadLength=this._opcode=
0;this._fragments=[];this._cleanupCallback=null;this._loop=this._dead=this._hadError=!1;this.onpong=this.onping=this.onerror=this.onclose=this.onmessage=null;this._state=0};require.prototype.readBuffer=function(bytes){var offset=0;this._bufferedBytes-=bytes;if(bytes===this._buffers[0].length)return this._buffers.shift();if(bytes<this._buffers[0].length){var dst=this._buffers[0].slice(0,bytes);this._buffers[0]=this._buffers[0].slice(bytes);return dst}for(dst=Buffer.allocUnsafe(bytes);0<bytes;){var l=
this._buffers[0].length;bytes>=l?(this._buffers[0].copy(dst,offset),offset+=l,this._buffers.shift()):(this._buffers[0].copy(dst,offset,0,bytes),this._buffers[0]=this._buffers[0].slice(bytes));bytes-=l}return dst};require.prototype.hasBufferedBytes=function(n){if(this._bufferedBytes>=n)return!0;this._loop=!1;this._dead&&this.cleanup(this._cleanupCallback);return!1};require.prototype.add=function(data){this._dead||(this._bufferedBytes+=data.length,this._buffers.push(data),this.startLoop())};require.prototype.startLoop=
function(){for(this._loop=!0;this._loop;)switch(this._state){case 0:this.getInfo();break;case 1:this.getPayloadLength16();break;case 2:this.getPayloadLength64();break;case 3:this.getMask();break;case 4:this.getData();break;default:this._loop=!1}};require.prototype.getInfo=function(){if(this.hasBufferedBytes(2)){var buf=this.readBuffer(2);if(0!==(buf[0]&48))this.error(Error("RSV2 and RSV3 must be clear"),1002);else{var compressed=64===(buf[0]&64);if(compressed&&!this._extensions[PerMessageDeflate.extensionName])this.error(Error("RSV1 must be clear"),
1002);else{this._fin=128===(buf[0]&128);this._opcode=buf[0]&15;this._payloadLength=buf[1]&127;if(0===this._opcode){if(compressed){this.error(Error("RSV1 must be clear"),1002);return}if(this._fragmented)this._opcode=this._fragmented;else{this.error(Error("invalid opcode: "+this._opcode),1002);return}}else if(1===this._opcode||2===this._opcode){if(this._fragmented){this.error(Error("invalid opcode: "+this._opcode),1002);return}this._compressed=compressed}else if(7<this._opcode&&11>this._opcode){if(!this._fin){this.error(Error("FIN must be set"),
1002);return}if(compressed){this.error(Error("RSV1 must be clear"),1002);return}if(125<this._payloadLength){this.error(Error("invalid payload length"),1002);return}}else{this.error(Error("invalid opcode: "+this._opcode),1002);return}this._fin||this._fragmented||(this._fragmented=this._opcode);this._masked=128===(buf[1]&128);126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength()}}}};require.prototype.getPayloadLength16=function(){this.hasBufferedBytes(2)&&
(this._payloadLength=this.readBuffer(2).readUInt16BE(0,!0),this.haveLength())};require.prototype.getPayloadLength64=function(){if(this.hasBufferedBytes(8)){var buf=this.readBuffer(8),num=buf.readUInt32BE(0,!0);num>Math.pow(2,21)-1?this.error(Error("max payload size exceeded"),1009):(this._payloadLength=num*Math.pow(2,32)+buf.readUInt32BE(4,!0),this.haveLength())}};require.prototype.haveLength=function(){8>this._opcode&&this.maxPayloadExceeded(this._payloadLength)||(this._state=this._masked?3:4)};
require.prototype.getMask=function(){this.hasBufferedBytes(4)&&(this._mask=this.readBuffer(4),this._state=4)};require.prototype.getData=function(){var data=constants.EMPTY_BUFFER;if(this._payloadLength){if(!this.hasBufferedBytes(this._payloadLength))return;data=this.readBuffer(this._payloadLength);this._masked&&bufferUtil.unmask(data,this._mask)}7<this._opcode?this.controlMessage(data):this._compressed?(this._state=5,this.decompress(data)):this.pushFragment(data)&&this.dataMessage()};require.prototype.decompress=
function(data){var $jscomp$this=this;this._extensions[PerMessageDeflate.extensionName].decompress(data,this._fin,function(err,buf){err?$jscomp$this.error(err,1009===err.closeCode?1009:1007):($jscomp$this.pushFragment(buf)&&$jscomp$this.dataMessage(),$jscomp$this.startLoop())})};require.prototype.dataMessage=function(){if(this._fin){var messageLength=this._messageLength,fragments=this._fragments;this._fragmented=this._messageLength=this._totalPayloadLength=0;this._fragments=[];if(2===this._opcode)"nodebuffer"===
this._binaryType?messageLength=toBuffer(fragments,messageLength):"arraybuffer"===this._binaryType?(messageLength=toBuffer(fragments,messageLength),messageLength=0===messageLength.byteOffset&&messageLength.byteLength===messageLength.buffer.byteLength?messageLength.buffer:messageLength.buffer.slice(messageLength.byteOffset,messageLength.byteOffset+messageLength.byteLength)):messageLength=fragments,this.onmessage(messageLength);else{messageLength=toBuffer(fragments,messageLength);if(!isValidUTF8(messageLength)){this.error(Error("invalid utf8 sequence"),
1007);return}this.onmessage(messageLength.toString())}}this._state=0};require.prototype.controlMessage=function(data){if(8===this._opcode)if(0===data.length)this.onclose(1E3,""),this._loop=!1,this.cleanup(this._cleanupCallback);else if(1===data.length)this.error(Error("invalid payload length"),1002);else{var code=data.readUInt16BE(0,!0);ErrorCodes.isValidErrorCode(code)?(data=data.slice(2),isValidUTF8(data)?(this.onclose(code,data.toString()),this._loop=!1,this.cleanup(this._cleanupCallback)):this.error(Error("invalid utf8 sequence"),
1007)):this.error(Error("invalid status code: "+code),1002)}else{if(9===this._opcode)this.onping(data);else this.onpong(data);this._state=0}};require.prototype.error=function(err,code){this.onerror(err,code);this._hadError=!0;this._loop=!1;this.cleanup(this._cleanupCallback)};require.prototype.maxPayloadExceeded=function(length){if(0===length||1>this._maxPayload)return!1;length=this._totalPayloadLength+length;if(length<=this._maxPayload)return this._totalPayloadLength=length,!1;this.error(Error("max payload size exceeded"),
1009);return!0};require.prototype.pushFragment=function(fragment){if(0===fragment.length)return!0;var totalLength=this._messageLength+fragment.length;if(1>this._maxPayload||totalLength<=this._maxPayload)return this._messageLength=totalLength,this._fragments.push(fragment),!0;this.error(Error("max payload size exceeded"),1009);return!1};require.prototype.cleanup=function(cb){this._dead=!0;this._hadError||!this._loop&&5!==this._state?(this.onpong=this.onping=this.onerror=this.onclose=this.onmessage=
this._cleanupCallback=this._mask=this._buffers=this._fragments=this._extensions=null,cb&&cb()):this._cleanupCallback=cb};module.exports=require}
//# sourceMappingURL=module$node_modules$ws$lib$Receiver.js.map
