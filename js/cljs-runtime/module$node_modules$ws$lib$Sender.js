shadow$provide.module$node_modules$ws$lib$Sender=function(global,require,module,exports){function viewToBuffer(view){var buf=Buffer.from(view.buffer);return view.byteLength!==view.buffer.byteLength?buf.slice(view.byteOffset,view.byteOffset+view.byteLength):buf}global=require("module$node_modules$safe_buffer$index");var crypto=require("module$node_modules$crypto_browserify$index"),PerMessageDeflate=require("module$node_modules$ws$lib$PerMessageDeflate"),bufferUtil=require("module$node_modules$ws$lib$BufferUtil"),
ErrorCodes=require("module$node_modules$ws$lib$ErrorCodes"),constants=require("module$node_modules$ws$lib$Constants"),Buffer=global.Buffer,Sender=function(socket,extensions){this._extensions=extensions||{};this._socket=socket;this._firstFragment=!0;this._compress=!1;this._bufferedBytes=0;this._deflating=!1;this._queue=[]};Sender.frame=function(data,options){var merge=1024>data.length||options.mask&&options.readOnly,offset=options.mask?6:2,payloadLength=data.length;65536<=data.length?(offset+=8,payloadLength=
127):125<data.length&&(offset+=2,payloadLength=126);var target=Buffer.allocUnsafe(merge?data.length+offset:offset);target[0]=options.fin?options.opcode|128:options.opcode;options.rsv1&&(target[0]|=64);126===payloadLength?target.writeUInt16BE(data.length,2,!0):127===payloadLength&&(target.writeUInt32BE(0,2,!0),target.writeUInt32BE(data.length,6,!0));if(!options.mask)return target[1]=payloadLength,merge?(data.copy(target,offset),[target]):[target,data];options=crypto.randomBytes(4);target[1]=payloadLength|
128;target[offset-4]=options[0];target[offset-3]=options[1];target[offset-2]=options[2];target[offset-1]=options[3];if(merge)return bufferUtil.mask(data,options,target,offset,data.length),[target];bufferUtil.mask(data,options,data,0,data.length);return[target,data]};Sender.prototype.close=function(code,data,mask,cb){if(void 0===code)code=1E3;else if("number"!==typeof code||!ErrorCodes.isValidErrorCode(code))throw Error("first argument must be a valid error code number");if(void 0===data||""===data)if(1E3===
code)var buf=constants.EMPTY_BUFFER;else buf=Buffer.allocUnsafe(2),buf.writeUInt16BE(code,0,!0);else buf=Buffer.allocUnsafe(2+Buffer.byteLength(data)),buf.writeUInt16BE(code,0,!0),buf.write(data,2);this._deflating?this.enqueue([this.doClose,buf,mask,cb]):this.doClose(buf,mask,cb)};Sender.prototype.doClose=function(data,mask,cb){this.sendFrame(Sender.frame(data,{fin:!0,rsv1:!1,opcode:8,mask:mask,readOnly:!1}),cb)};Sender.prototype.ping=function(data,mask){var readOnly=!0;Buffer.isBuffer(data)||(data instanceof
ArrayBuffer?data=Buffer.from(data):ArrayBuffer.isView(data)?data=viewToBuffer(data):(data=Buffer.from(data),readOnly=!1));this._deflating?this.enqueue([this.doPing,data,mask,readOnly]):this.doPing(data,mask,readOnly)};Sender.prototype.doPing=function(data,mask,readOnly){this.sendFrame(Sender.frame(data,{fin:!0,rsv1:!1,opcode:9,mask:mask,readOnly:readOnly}))};Sender.prototype.pong=function(data,mask){var readOnly=!0;Buffer.isBuffer(data)||(data instanceof ArrayBuffer?data=Buffer.from(data):ArrayBuffer.isView(data)?
data=viewToBuffer(data):(data=Buffer.from(data),readOnly=!1));this._deflating?this.enqueue([this.doPong,data,mask,readOnly]):this.doPong(data,mask,readOnly)};Sender.prototype.doPong=function(data,mask,readOnly){this.sendFrame(Sender.frame(data,{fin:!0,rsv1:!1,opcode:10,mask:mask,readOnly:readOnly}))};Sender.prototype.send=function(data,options,cb){var opcode=options.binary?2:1,rsv1=options.compress,readOnly=!0;Buffer.isBuffer(data)||(data instanceof ArrayBuffer?data=Buffer.from(data):ArrayBuffer.isView(data)?
data=viewToBuffer(data):(data=Buffer.from(data),readOnly=!1));var perMessageDeflate=this._extensions[PerMessageDeflate.extensionName];this._firstFragment?(this._firstFragment=!1,rsv1&&perMessageDeflate&&(rsv1=data.length>=perMessageDeflate._threshold),this._compress=rsv1):(rsv1=!1,opcode=0);options.fin&&(this._firstFragment=!0);perMessageDeflate?(options={fin:options.fin,rsv1:rsv1,opcode:opcode,mask:options.mask,readOnly:readOnly},this._deflating?this.enqueue([this.dispatch,data,this._compress,options,
cb]):this.dispatch(data,this._compress,options,cb)):this.sendFrame(Sender.frame(data,{fin:options.fin,rsv1:!1,opcode:opcode,mask:options.mask,readOnly:readOnly}),cb)};Sender.prototype.dispatch=function(data,compress,options,cb){var $jscomp$this=this;compress?(compress=this._extensions[PerMessageDeflate.extensionName],this._deflating=!0,compress.compress(data,options.fin,function(_,buf){options.readOnly=!1;$jscomp$this.sendFrame(Sender.frame(buf,options),cb);$jscomp$this._deflating=!1;$jscomp$this.dequeue()})):
this.sendFrame(Sender.frame(data,options),cb)};Sender.prototype.dequeue=function(){for(;!this._deflating&&this._queue.length;){var params=this._queue.shift();this._bufferedBytes-=params[1].length;params[0].apply(this,params.slice(1))}};Sender.prototype.enqueue=function(params){this._bufferedBytes+=params[1].length;this._queue.push(params)};Sender.prototype.sendFrame=function(list,cb){2===list.length?(this._socket.write(list[0]),this._socket.write(list[1],cb)):this._socket.write(list[0],cb)};module.exports=
Sender}
//# sourceMappingURL=module$node_modules$ws$lib$Sender.js.map
